<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claude AI (Puter)</title>

  <script src="https://js.puter.com/v2/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#101014;
      --panel2:#15151b;
      --border: rgba(255,255,255,.09);
      --border2: rgba(255,255,255,.14);
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --muted2:#71717a;
      --accent:#c9a87c;
      --accent2:#a88a5c;
      --ok:#4ade80;
      --warn:#fbbf24;
      --err:#fb7185;
      --purple:#a78bfa;
      --radius:14px;
      --shadow: 0 14px 50px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 800px at 30% -10%, rgba(201,168,124,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(167,139,250,.08), transparent 60%),
        var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .app{
      height:100%;
      display:flex;
    }

    /* ===== main ===== */
    .main{
      flex: 1;
      min-width: 0;
      display:flex;
      flex-direction:column;
    }

    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(11,11,13,.82);
      backdrop-filter: blur(14px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: .2px;
    }

    .badge{
      width: 36px; height: 36px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b0b0d;
      box-shadow: 0 0 35px rgba(201,168,124,.18);
      font-weight: 900;
    }

    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--ok); box-shadow: 0 0 10px rgba(74,222,128,.45); }
    .dot.vision{ background: var(--purple); box-shadow: 0 0 10px rgba(167,139,250,.45); }

    select{
      appearance:none;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      font-size: 13px;
      outline: none;
      cursor:pointer;
    }
    select:hover{ border-color: var(--border2); }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      font-size: 13px;
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
    }
    .btn:hover{
      background: rgba(255,255,255,.06);
      border-color: var(--border2);
      color: var(--text);
    }

    /* ===== chat ===== */
    .chat{
      flex:1;
      overflow:auto;
      padding: 16px;
    }

    .chat::-webkit-scrollbar{ width: 8px; }
    .chat::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius: 999px; }
    .chat::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.16); }

    .welcome{
      max-width: 860px;
      margin: 42px auto 0;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    }
    .welcome h1{ font-size: 20px; margin-bottom: 10px; }
    .welcome p{ color: var(--muted); font-size: 14px; line-height: 1.6; }

    .msg{
      max-width: 860px;
      margin: 0 auto 18px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      animation: in .22s ease;
    }
    @keyframes in{ from{opacity:0; transform: translateY(8px);} to{opacity:1; transform:none;} }

    .avatar{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display:grid;
      place-items:center;
      flex:0 0 auto;
      background: rgba(255,255,255,.03);
      font-weight: 800;
      user-select:none;
    }
    .avatar.ai{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b0b0d;
      border-color: rgba(201,168,124,.35);
      box-shadow: 0 0 18px rgba(201,168,124,.12);
    }

    .bubble{
      flex:1 1 auto;
      min-width:0;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      color: var(--muted2);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .name{ color: var(--text); font-weight: 600; font-size: 13px; }

    .images{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin: 10px 0 10px;
    }
    .images img{
      width: 260px;
      max-width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: .15s ease;
    }
    .images img:hover{
      transform: scale(1.01);
      border-color: rgba(201,168,124,.55);
    }

    .text{
      font-size: 14px;
      line-height: 1.75;
      color: var(--text);
      word-break: break-word;
    }
    .text code{
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 8px;
      color: #f0abfc;
    }
    .text pre{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:auto;
      margin: 12px 0;
    }
    .text pre code{
      display:block;
      padding: 14px;
      background: #0d1117;
      border: none;
      color: inherit;
    }

    .typing{
      display:flex;
      gap: 10px;
      align-items:center;
      color: var(--muted2);
      font-size: 13px;
      user-select:none;
    }
    .dots{ display:flex; gap: 4px; }
    .dots span{
      width: 7px; height:7px;
      background: var(--accent);
      border-radius: 999px;
      animation: bounce 1.1s infinite ease-in-out;
      opacity:.7;
    }
    .dots span:nth-child(2){ animation-delay: .12s; }
    .dots span:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{ 0%, 60%, 100%{ transform:none; opacity:.5 } 30%{ transform: translateY(-6px); opacity: 1 } }

    /* ===== composer ===== */
    .composer{
      padding: 14px 16px 18px;
      border-top: 1px solid var(--border);
      background: linear-gradient(to top, rgba(11,11,13,.98) 70%, rgba(11,11,13,.20));
    }
    .composer-inner{
      max-width: 860px;
      margin: 0 auto;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .composer-inner:focus-within{
      border-color: rgba(201,168,124,.55);
      box-shadow: var(--shadow), 0 0 0 3px rgba(201,168,124,.12);
    }

    .preview{
      display:none;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .preview.active{ display:flex; }
    .preview-item{
      position: relative;
      width: 72px; height:72px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .preview-item img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .preview-remove{
      position:absolute;
      top:-8px; right:-8px;
      width: 24px; height:24px;
      border-radius: 999px;
      border: 2px solid rgba(11,11,13,.9);
      background: var(--err);
      color: #0b0b0d;
      font-weight: 900;
      cursor:pointer;
    }

    .row{
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      border:none;
      outline:none;
      resize:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      min-height: 24px;
      max-height: 160px;
      padding: 2px 0;
    }
    textarea::placeholder{ color: var(--muted2); }

    .iconbtn{
      width: 42px; height:42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
    }
    .iconbtn:hover{ background: rgba(255,255,255,.06); border-color: var(--border2); color: var(--text); }

    .send{
      width: 42px; height:42px;
      border-radius: 14px;
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b0b0d;
      font-weight: 900;
      cursor:pointer;
      transition: .15s ease;
    }
    .send:hover{ transform: translateY(-1px); }
    .send:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* ===== artifacts panel ===== */
    .side{
      width: 0;
      border-left: 1px solid var(--border);
      background: rgba(16,16,20,.92);
      backdrop-filter: blur(10px);
      overflow:hidden;
      transition: width .22s ease;
      display:flex;
      flex-direction:column;
    }
    .side.open{
      width: min(52vw, 620px);
    }

    .side-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(21,21,27,.9);
    }
    .side-title{
      font-weight: 700;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .side-title .bolt{
      width: 28px; height:28px;
      border-radius: 10px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--purple), #7c3aed);
      color: #0b0b0d;
      font-weight: 900;
    }
    .side-tabs{
      display:flex;
      gap: 6px;
      align-items:center;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
    }
    .tab:hover{ background: rgba(255,255,255,.06); }
    .tab.active{
      background: rgba(255,255,255,.08);
      border-color: var(--border);
      color: var(--text);
    }
    .xbtn{
      width: 34px; height:34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 18px;
    }
    .xbtn:hover{ background: rgba(255,255,255,.06); color: var(--text); }

    .side-body{
      flex:1;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .codeview, .previewview{ flex:1; overflow:auto; display:none; }
    .codeview.active{ display:block; }
    .previewview.active{ display:block; background:#fff; }
    .codeview pre{ margin:0; min-height:100%; background:#0d1117; }
    .codeview code{ display:block; padding: 14px; font-family:"JetBrains Mono", monospace; font-size: 13px; line-height: 1.6; }
    .previewview iframe{ width:100%; height:100%; border:none; }

    .side-actions{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display:flex;
      gap: 10px;
      background: rgba(21,21,27,.9);
    }
    .side-actions button{
      flex:1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
    }
    .side-actions button:hover{ background: rgba(255,255,255,.08); border-color: var(--border2); }
    .side-actions button.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b0b0d;
      font-weight: 800;
    }

    /* ===== modal ===== */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.92);
      z-index: 999;
      padding: 30px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:100%;
      max-height:100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      object-fit: contain;
    }
    .modal button{
      position:absolute;
      top: 18px; right: 18px;
      width: 44px; height:44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size: 18px;
    }

    /* ===== drop overlay ===== */
    .drop{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 10px;
      background: rgba(11,11,13,.92);
      border: 2px dashed rgba(201,168,124,.5);
      z-index: 900;
    }
    .drop.active{ display:flex; }
    .drop .big{ font-size: 44px; }
    .drop .t{ font-size: 16px; color: var(--muted); }

    @media (max-width: 980px){
      .side.open{ width: 100vw; position: fixed; inset:0; z-index: 800; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="main">
      <div class="header">
        <div class="brand">
          <div class="badge">‚ú¶</div>
          <div>Claude AI</div>
        </div>

        <div class="controls">
          <div class="pill" id="modePill">
            <span class="dot" id="modeDot"></span>
            <span id="modeLabel">Chat</span>
          </div>

          <select id="modelSelect">
            <option value="claude-opus-4-5">Claude Opus 4.5</option>
            <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5</option>
            <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
            <option value="gpt-4o">GPT-4o (backup)</option>
          </select>

          <button class="btn" id="newBtn">New chat</button>
        </div>
      </div>

      <div class="chat" id="chat">
        <div class="welcome" id="welcome">
          <h1>Ask anything ‚Äî upload an image if you want.</h1>
          <p>
            Text chat has memory. Image questions use the image <b>one time</b> (it won‚Äôt keep reusing it).
            If you ask for a website, I‚Äôll try to return an <b>artifact</b> you can preview and download.
          </p>
          <p style="margin-top:10px;color:var(--muted2);font-size:13px;">
            If you ever get stuck on ‚ÄúThinking‚Ä¶‚Äù, it‚Äôs usually popups/adblock blocking Puter login. Allow popups for this site.
          </p>
        </div>
      </div>

      <div class="composer">
        <div class="composer-inner">
          <div class="preview" id="preview"></div>

          <div class="row">
            <textarea id="input" rows="1" placeholder="Message Claude‚Ä¶ (Enter to send, Shift+Enter newline)"></textarea>
            <button class="iconbtn" id="imageBtn" title="Upload image">üì∑</button>
            <button class="send" id="sendBtn" title="Send">‚û§</button>
          </div>
        </div>

        <input id="fileInput" type="file" accept="image/*" hidden />
      </div>
    </div>

    <!-- Artifacts side panel -->
    <aside class="side" id="side">
      <div class="side-head">
        <div class="side-title"><span class="bolt">‚ö°</span><span id="artifactTitle">Artifact</span></div>
        <div class="side-tabs">
          <button class="tab active" id="tabCode">Code</button>
          <button class="tab" id="tabPrev">Preview</button>
        </div>
        <button class="xbtn" id="closeSide">√ó</button>
      </div>

      <div class="side-body">
        <div class="codeview active" id="codeView"><pre><code id="artifactCode"></code></pre></div>
        <div class="previewview" id="prevView"><iframe id="artifactFrame" sandbox="allow-scripts"></iframe></div>
      </div>

      <div class="side-actions">
        <button id="copyArtifact">Copy</button>
        <button id="downloadArtifact">Download</button>
        <button class="primary" id="openArtifact">Open</button>
      </div>
    </aside>
  </div>

  <div class="drop" id="drop">
    <div class="big">üì∑</div>
    <div class="t">Drop image to upload</div>
  </div>

  <div class="modal" id="modal">
    <button id="closeModal">√ó</button>
    <img id="modalImg" alt="image" />
  </div>

  <script>
    // ---------------------------
    // State
    // ---------------------------
    const state = {
      busy: false,
      pendingFile: null,
      pendingPreviewUrl: null,
      history: [], // {role:'user'|'assistant', content:string}
      artifacts: new Map(), // id -> {type, code, name}
      currentArtifactId: null
    };

    // ---------------------------
    // Elements
    // ---------------------------
    const chatEl = document.getElementById('chat');
    const welcomeEl = document.getElementById('welcome');
    const inputEl = document.getElementById('input');
    const sendBtnEl = document.getElementById('sendBtn');
    const imageBtnEl = document.getElementById('imageBtn');
    const fileInputEl = document.getElementById('fileInput');
    const previewEl = document.getElementById('preview');
    const modelSelectEl = document.getElementById('modelSelect');
    const newBtnEl = document.getElementById('newBtn');

    const modePillEl = document.getElementById('modePill');
    const modeDotEl = document.getElementById('modeDot');
    const modeLabelEl = document.getElementById('modeLabel');

    const sideEl = document.getElementById('side');
    const artifactTitleEl = document.getElementById('artifactTitle');
    const artifactCodeEl = document.getElementById('artifactCode');
    const artifactFrameEl = document.getElementById('artifactFrame');
    const codeViewEl = document.getElementById('codeView');
    const prevViewEl = document.getElementById('prevView');
    const tabCodeEl = document.getElementById('tabCode');
    const tabPrevEl = document.getElementById('tabPrev');
    const closeSideEl = document.getElementById('closeSide');
    const copyArtifactEl = document.getElementById('copyArtifact');
    const downloadArtifactEl = document.getElementById('downloadArtifact');
    const openArtifactEl = document.getElementById('openArtifact');

    const dropEl = document.getElementById('drop');

    const modalEl = document.getElementById('modal');
    const modalImgEl = document.getElementById('modalImg');
    const closeModalEl = document.getElementById('closeModal');

    // ---------------------------
    // Prompts
    // ---------------------------
    const CODING_SYSTEM = `
You are a top-tier coding assistant.
If the user asks for a website/app UI/code, respond with a complete working artifact.

Use this exact format:
\`\`\`artifact:html
<!doctype html>
<html>
<head>...CSS...</head>
<body>...HTML...
<script>...JS...</script>
</body>
</html>
\`\`\`

Rules:
- Always include full HTML (with CSS + JS if needed).
- Make it polished, responsive, and modern.
- Avoid placeholders like "..." in critical parts; output real code.
`.trim();

    const VISION_SYSTEM = `
You are an advanced vision assistant.
Be accurate and detailed.
If there is text, transcribe it exactly.
If unsure, say what is unclear.
`.trim();

    // ---------------------------
    // Helpers
    // ---------------------------
    function setMode(mode){
      if (mode === 'vision'){
        modeDotEl.classList.add('vision');
        modeLabelEl.textContent = 'Vision';
      } else {
        modeDotEl.classList.remove('vision');
        modeLabelEl.textContent = 'Chat';
      }
    }

    function scrollToBottom(){
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function autosize(){
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
    }

    function escapeHtml(s){
      return (s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function withTimeout(promise, ms = 45000){
      return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error('Request timed out (try again / switch model).')), ms);
        promise.then(v => { clearTimeout(t); resolve(v); })
               .catch(e => { clearTimeout(t); reject(e); });
      });
    }

    function extractTextFromPuterResponse(res){
      if (res == null) return '';
      if (typeof res === 'string') return res;

      const c = res?.message?.content;
      if (Array.isArray(c)){
        return c.filter(b => b?.type === 'text' && typeof b?.text === 'string')
                .map(b => b.text).join('\n').trim();
      }
      if (typeof c === 'string') return c;
      if (typeof res?.text === 'string') return res.text;
      if (typeof res?.content === 'string') return res.content;

      return JSON.stringify(res, null, 2);
    }

    function nowTime(){
      return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    // ---------------------------
    // Message UI
    // ---------------------------
    function addMessage({role, name, avatarText, isAI, text, imageUrls=[]}){
      welcomeEl.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = 'msg';

      const avatar = document.createElement('div');
      avatar.className = 'avatar' + (isAI ? ' ai' : '');
      avatar.textContent = avatarText;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span class="name">${escapeHtml(name)}</span><span>${escapeHtml(nowTime())}</span>`;

      const images = document.createElement('div');
      images.className = 'images';
      if (imageUrls.length){
        for (const url of imageUrls){
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'image';
          img.addEventListener('click', () => openModal(url));
          images.appendChild(img);
        }
      }

      const content = document.createElement('div');
      content.className = 'text';

      bubble.appendChild(meta);
      if (imageUrls.length) bubble.appendChild(images);
      bubble.appendChild(content);

      msg.appendChild(avatar);
      msg.appendChild(bubble);

      chatEl.appendChild(msg);
      scrollToBottom();
      return content;
    }

    function addTyping(){
      const content = addMessage({
        role: 'assistant',
        name: 'Claude',
        avatarText: '‚ú¶',
        isAI: true,
        text: ''
      });

      content.dataset.typing = '1';
      content.innerHTML = `
        <div class="typing">
          <div class="dots"><span></span><span></span><span></span></div>
          <div>Thinking‚Ä¶</div>
        </div>
      `;
    }

    function removeTyping(){
      const el = chatEl.querySelector('[data-typing="1"]');
      if (el) el.closest('.msg').remove();
    }

    // ---------------------------
    // Rendering assistant output with artifacts
    // ---------------------------
    function parseArtifacts(text){
      const artifacts = [];
      const re = /```artifact:(\w+)\n([\s\S]*?)```/g;
      let last = 0;
      let m;

      while ((m = re.exec(text)) !== null){
        artifacts.push({ kind:'text', value: text.slice(last, m.index) });

        const type = m[1].toLowerCase();
        const code = m[2].trim();
        artifacts.push({ kind:'artifact', type, code });

        last = m.index + m[0].length;
      }

      artifacts.push({ kind:'text', value: text.slice(last) });
      return artifacts.filter(x => x.kind !== 'text' || x.value.trim() !== '');
    }

    function renderTextMarkdownToEl(el, text){
      // minimal safe markdown: code fences + inline code + line breaks
      // We build DOM nodes so highlight.js works reliably.
      el.innerHTML = '';

      const parts = [];
      const re = /```(\w*)\n([\s\S]*?)```/g;
      let last = 0, m;

      while ((m = re.exec(text)) !== null){
        const before = text.slice(last, m.index);
        if (before.trim() !== '') parts.push({type:'text', value: before});

        const lang = (m[1] || '').trim();
        const code = (m[2] || '').trim();
        parts.push({type:'code', lang, value: code});
        last = m.index + m[0].length;
      }
      const rest = text.slice(last);
      if (rest.trim() !== '') parts.push({type:'text', value: rest});

      for (const p of parts){
        if (p.type === 'text'){
          const div = document.createElement('div');
          // escape HTML then basic inline code with backticks
          let safe = escapeHtml(p.value);
          safe = safe.replace(/`([^`]+)`/g, '<code>$1</code>');
          safe = safe.replace(/\n/g, '<br>');
          div.innerHTML = safe;
          el.appendChild(div);
        } else {
          const pre = document.createElement('pre');
          const codeEl = document.createElement('code');
          codeEl.textContent = p.value;
          if (p.lang) codeEl.className = `language-${p.lang}`;
          pre.appendChild(codeEl);
          el.appendChild(pre);
          try { hljs.highlightElement(codeEl); } catch {}
        }
      }
    }

    function renderAssistantResponse(el, fullText){
      // Split on artifact blocks, render each segment into DOM.
      el.innerHTML = '';

      const segments = parseArtifacts(fullText);

      for (const seg of segments){
        if (seg.kind === 'text'){
          const box = document.createElement('div');
          renderTextMarkdownToEl(box, seg.value);
          el.appendChild(box);
        } else if (seg.kind === 'artifact'){
          const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
          const name = `${seg.type.toUpperCase()} Artifact`;
          state.artifacts.set(id, { id, type: seg.type, code: seg.code, name });
          state.currentArtifactId = id;

          const card = document.createElement('div');
          card.style.marginTop = '12px';
          card.style.border = '1px solid rgba(255,255,255,.10)';
          card.style.borderRadius = '14px';
          card.style.overflow = 'hidden';
          card.style.background = 'rgba(255,255,255,.03)';

          const head = document.createElement('div');
          head.style.display = 'flex';
          head.style.alignItems = 'center';
          head.style.justifyContent = 'space-between';
          head.style.gap = '10px';
          head.style.padding = '10px 12px';
          head.style.borderBottom = '1px solid rgba(255,255,255,.10)';
          head.style.background = 'rgba(255,255,255,.03)';

          head.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;font-weight:700;font-size:12px;">
              <span style="width:22px;height:22px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg, var(--purple), #7c3aed);color:#0b0b0d;font-weight:900;">‚ö°</span>
              <span>${escapeHtml(name)}</span>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn" data-action="artifact-copy" data-id="${id}" style="padding:7px 10px;font-size:12px;">Copy</button>
              <button class="btn" data-action="artifact-open" data-id="${id}" style="padding:7px 10px;font-size:12px;">Open</button>
              <button class="btn" data-action="artifact-download" data-id="${id}" style="padding:7px 10px;font-size:12px;">Download</button>
            </div>
          `;

          const body = document.createElement('div');
          body.style.height = '220px';
          body.style.background = '#fff';

          if (seg.type === 'html' || seg.type === 'htm'){
            const iframe = document.createElement('iframe');
            iframe.sandbox = 'allow-scripts';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.srcdoc = seg.code;
            body.appendChild(iframe);
          } else {
            // non-html: show code snippet
            body.style.background = '#0d1117';
            body.style.color = '#e5e7eb';
            body.style.padding = '12px';
            body.style.overflow = 'auto';
            const pre = document.createElement('pre');
            pre.style.margin = '0';
            const code = document.createElement('code');
            code.textContent = seg.code;
            pre.appendChild(code);
            body.appendChild(pre);
            try { hljs.highlightElement(code); } catch {}
          }

          card.appendChild(head);
          card.appendChild(body);

          el.appendChild(card);
        }
      }
    }

    // ---------------------------
    // Artifact side panel
    // ---------------------------
    function openArtifact(id){
      const a = state.artifacts.get(id);
      if (!a) return;

      state.currentArtifactId = id;
      artifactTitleEl.textContent = a.name;

      artifactCodeEl.textContent = a.code;
      try { hljs.highlightElement(artifactCodeEl); } catch {}

      // Preview only for html
      if (a.type === 'html' || a.type === 'htm'){
        artifactFrameEl.srcdoc = a.code;
      } else {
        artifactFrameEl.srcdoc = `<pre style="white-space:pre-wrap;padding:14px;font-family:ui-monospace,monospace;">${escapeHtml(a.code)}</pre>`;
      }

      sideEl.classList.add('open');
      showTab('code');
    }

    function closeArtifactPanel(){
      sideEl.classList.remove('open');
    }

    function showTab(tab){
      if (tab === 'code'){
        tabCodeEl.classList.add('active');
        tabPrevEl.classList.remove('active');
        codeViewEl.classList.add('active');
        prevViewEl.classList.remove('active');
      } else {
        tabCodeEl.classList.remove('active');
        tabPrevEl.classList.add('active');
        codeViewEl.classList.remove('active');
        prevViewEl.classList.add('active');
      }
    }

    async function copyCurrentArtifact(){
      const a = state.artifacts.get(state.currentArtifactId);
      if (!a) return;
      await navigator.clipboard.writeText(a.code);
    }

    function downloadCurrentArtifact(){
      const a = state.artifacts.get(state.currentArtifactId);
      if (!a) return;
      const ext = a.type === 'html' ? 'html' : a.type;
      const blob = new Blob([a.code], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `artifact.${ext}`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function openCurrentArtifactNewTab(){
      const a = state.artifacts.get(state.currentArtifactId);
      if (!a) return;
      const w = window.open('', '_blank', 'noopener,noreferrer');
      w.document.open();
      w.document.write(a.code);
      w.document.close();
    }

    // ---------------------------
    // Modal
    // ---------------------------
    function openModal(src){
      modalImgEl.src = src;
      modalEl.classList.add('active');
    }
    function closeModal(){
      modalEl.classList.remove('active');
      modalImgEl.src = '';
    }

    // ---------------------------
    // Image preview (one-time use)
    // ---------------------------
    function clearPendingImage(){
      if (state.pendingPreviewUrl) {
        try { URL.revokeObjectURL(state.pendingPreviewUrl); } catch {}
      }
      state.pendingFile = null;
      state.pendingPreviewUrl = null;
      previewEl.classList.remove('active');
      previewEl.innerHTML = '';
      setMode('chat');
    }

    function setPendingImage(file){
      if (!file || !file.type.startsWith('image/')) return;

      clearPendingImage();
      state.pendingFile = file;
      state.pendingPreviewUrl = URL.createObjectURL(file);

      previewEl.classList.add('active');
      previewEl.innerHTML = `
        <div class="preview-item">
          <img src="${state.pendingPreviewUrl}" alt="preview" />
          <button class="preview-remove" title="remove">√ó</button>
        </div>
      `;

      previewEl.querySelector('.preview-remove').addEventListener('click', clearPendingImage);
      previewEl.querySelector('img').addEventListener('click', () => openModal(state.pendingPreviewUrl));
      setMode('vision');
    }

    async function fileToBase64Parts(file){
      const dataUrl = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(new Error('Failed to read image file'));
        r.readAsDataURL(file);
      });

      const m = String(dataUrl).match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.+)$/);
      if (!m) throw new Error('Invalid image encoding');
      return { media_type: m[1], data: m[2] };
    }

    // ---------------------------
    // Calls (NO streaming)
    // ---------------------------
    async function callText(model, userText){
      // Keep lightweight memory by storing turns and sending last N as a transcript.
      // This avoids weird ‚Äúmessages array shape‚Äù incompatibilities.
      state.history.push({ role:'user', content: userText });

      const lastTurns = state.history.slice(-16).map(m => `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`).join('\n');

      const prompt =
`${CODING_SYSTEM}

Conversation (recent):
${lastTurns}

Now respond to the user's latest message.`;

      const res = await withTimeout(puter.ai.chat(prompt, { model, stream:false }), 45000);
      const txt = extractTextFromPuterResponse(res);
      state.history.push({ role:'assistant', content: txt });
      return txt;
    }

    async function callVision(model, userText, file){
      const parts = await fileToBase64Parts(file);

      const content = [
        {
          type: 'image',
          source: { type:'base64', media_type: parts.media_type, data: parts.data }
        },
        {
          type: 'text',
          text:
`${VISION_SYSTEM}

User request:
${userText || 'Analyze this image.'}

Be detailed. If there is text, transcribe it exactly.`
        }
      ];

      const res = await withTimeout(
        puter.ai.chat([{ role:'user', content }], { model, stream:false }),
        45000
      );

      return extractTextFromPuterResponse(res);
    }

    // ---------------------------
    // Send (FIXED: message always shows, typing always removed)
    // ---------------------------
    async function send(){
      if (state.busy) return;

      const model = modelSelectEl.value;
      const userText = inputEl.value.trim();
      const hasImage = !!state.pendingFile;

      if (!userText && !hasImage) return;

      state.busy = true;
      sendBtnEl.disabled = true;

      // show user message immediately
      const shownText = userText || (hasImage ? 'Analyze this image.' : '');
      const imgUrl = state.pendingPreviewUrl ? [state.pendingPreviewUrl] : [];
      addMessage({
        role:'user',
        name:'You',
        avatarText:'üë§',
        isAI:false,
        text: shownText,
        imageUrls: imgUrl
      }).innerHTML = escapeHtml(shownText);

      // clear input
      inputEl.value = '';
      autosize();

      // IMPORTANT: image should be used ONCE, then cleared
      const fileForThisRequest = state.pendingFile;
      if (hasImage) {
        // do NOT revoke objectURL yet (we still display it in the message)
        state.pendingFile = null;
        state.pendingPreviewUrl = null;
        previewEl.classList.remove('active');
        previewEl.innerHTML = '';
        setMode('chat');
      }

      addTyping();

      try {
        const assistantEl = addMessage({
          role:'assistant',
          name:'Claude',
          avatarText:'‚ú¶',
          isAI:true,
          text:''
        });

        let answer = '';
        if (fileForThisRequest) {
          answer = await callVision(model, shownText, fileForThisRequest);
        } else {
          answer = await callText(model, shownText);
        }

        removeTyping();

        // render assistant answer + artifacts
        renderAssistantResponse(assistantEl, answer || '(No text returned.)');
        scrollToBottom();
      } catch (e) {
        removeTyping();
        const errBox = addMessage({
          role:'assistant',
          name:'Claude',
          avatarText:'‚ú¶',
          isAI:true,
          text:''
        });

        errBox.innerHTML =
          `<div style="padding:10px;border:1px solid rgba(251,113,133,.35);border-radius:12px;background:rgba(251,113,133,.08);color:#fecdd3;">
            <b>Error:</b> ${escapeHtml(e?.message || String(e))}<br><br>
            Fixes: allow popups / disable adblock for this site (Puter login), or switch model to GPT-4o.
          </div>`;
      } finally {
        state.busy = false;
        sendBtnEl.disabled = false;
        inputEl.focus();
      }
    }

    // ---------------------------
    // New chat
    // ---------------------------
    function newChat(){
      state.history = [];
      state.artifacts.clear();
      state.currentArtifactId = null;
      clearPendingImage();
      closeArtifactPanel();

      chatEl.innerHTML = '';
      chatEl.appendChild(welcomeEl);
      welcomeEl.style.display = '';
      inputEl.value = '';
      autosize();
      setMode('chat');
      inputEl.focus();
    }

    // ---------------------------
    // Event wiring (stable, no inline onclick bugs)
    // ---------------------------
    sendBtnEl.addEventListener('click', send);
    inputEl.addEventListener('input', autosize);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    imageBtnEl.addEventListener('click', () => fileInputEl.click());
    fileInputEl.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) setPendingImage(f);
      fileInputEl.value = '';
    });

    // paste images
    document.addEventListener('paste', (e) => {
      const items = Array.from(e.clipboardData?.items || []);
      const img = items.find(it => it.type && it.type.startsWith('image/'));
      if (!img) return;
      e.preventDefault();
      setPendingImage(img.getAsFile());
    });

    // drag drop
    let dragCounter = 0;
    document.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragCounter++;
      dropEl.classList.add('active');
    });
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dragCounter = Math.max(0, dragCounter - 1);
      if (dragCounter === 0) dropEl.classList.remove('active');
    });
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      dragCounter = 0;
      dropEl.classList.remove('active');
      const f = e.dataTransfer?.files?.[0];
      if (f) setPendingImage(f);
    });

    // modal
    closeModalEl.addEventListener('click', closeModal);
    modalEl.addEventListener('click', (e) => {
      if (e.target === modalEl) closeModal();
    });

    // artifact panel
    closeSideEl.addEventListener('click', closeArtifactPanel);
    tabCodeEl.addEventListener('click', () => showTab('code'));
    tabPrevEl.addEventListener('click', () => showTab('preview'));
    copyArtifactEl.addEventListener('click', async () => { await copyCurrentArtifact(); });
    downloadArtifactEl.addEventListener('click', downloadCurrentArtifact);
    openArtifactEl.addEventListener('click', openCurrentArtifactNewTab);

    // new chat
    newBtnEl.addEventListener('click', newChat);

    // click handling for artifact buttons inside messages (event delegation)
    chatEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');

      if (action === 'artifact-open') openArtifact(id);
      if (action === 'artifact-copy') {
        const a = state.artifacts.get(id);
        if (!a) return;
        await navigator.clipboard.writeText(a.code);
      }
      if (action === 'artifact-download') {
        const a = state.artifacts.get(id);
        if (!a) return;
        state.currentArtifactId = id;
        downloadCurrentArtifact();
      }
    });

    // escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape'){
        closeModal();
        closeArtifactPanel();
      }
    });

    // init
    inputEl.focus();
    autosize();
    setMode('chat');
  </script>
</body>
        </html>
