<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Claude AI (Puter) ‚Äî Stable</title>

  <!-- Puter.js (we also auto-reload it in JS if blocked) -->
  <script src="https://js.puter.com/v2/"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#101014;
      --panel2:#15151b;
      --border: rgba(255,255,255,.09);
      --border2: rgba(255,255,255,.14);
      --text:#f4f4f5;
      --muted:#a1a1aa;
      --muted2:#71717a;
      --accent:#c9a87c;
      --accent2:#a88a5c;
      --ok:#4ade80;
      --warn:#fbbf24;
      --err:#fb7185;
      --purple:#a78bfa;
      --shadow: 0 14px 50px rgba(0,0,0,.45);
      --r:14px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 800px at 30% -10%, rgba(201,168,124,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(167,139,250,.08), transparent 60%),
        var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .app{ height:100%; display:flex; }
    .main{ flex:1; min-width:0; display:flex; flex-direction:column; }

    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(11,11,13,.82);
      backdrop-filter: blur(14px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{ display:flex; align-items:center; gap: 10px; font-weight:700; }
    .badge{
      width: 36px; height: 36px; border-radius: 12px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b0b0d;
      box-shadow: 0 0 35px rgba(201,168,124,.18);
      font-weight: 900;
      user-select:none;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap: wrap; justify-content:flex-end;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--ok); box-shadow: 0 0 10px rgba(74,222,128,.45); }
    .dot.vision{ background: var(--purple); box-shadow: 0 0 10px rgba(167,139,250,.45); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 10px rgba(251,191,36,.45); }
    .dot.err{ background: var(--err); box-shadow: 0 0 10px rgba(251,113,133,.45); }

    select{
      appearance:none;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      font-size: 13px;
      outline: none;
      cursor:pointer;
    }
    select:hover{ border-color: var(--border2); }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      font-size: 13px;
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.06); border-color: var(--border2); color: var(--text); }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0b0b0d;
      font-weight: 800;
    }

    .banner{
      max-width: 860px;
      margin: 10px auto 0;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      display:none;
    }
    .banner.show{ display:block; }
    .banner strong{ color: var(--text); }

    .chat{ flex:1; overflow:auto; padding: 8px 16px 18px; }
    .chat::-webkit-scrollbar{ width:8px; }
    .chat::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; }

    .welcome{
      max-width: 860px;
      margin: 24px auto 0;
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    }
    .welcome h1{ font-size: 20px; margin-bottom: 10px; }
    .welcome p{ color: var(--muted); font-size: 14px; line-height: 1.6; }

    .msg{
      max-width: 860px;
      margin: 0 auto 18px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
      animation: in .22s ease;
    }
    @keyframes in{ from{opacity:0; transform: translateY(8px);} to{opacity:1; transform:none;} }

    .avatar{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display:grid;
      place-items:center;
      flex:0 0 auto;
      background: rgba(255,255,255,.03);
      font-weight: 800;
      user-select:none;
    }
    .avatar.ai{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0b0b0d;
      border-color: rgba(201,168,124,.35);
      box-shadow: 0 0 18px rgba(201,168,124,.12);
    }

    .bubble{ flex:1 1 auto; min-width:0; }
    .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      color: var(--muted2);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .name{ color: var(--text); font-weight: 600; font-size: 13px; }

    .images{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin: 10px 0 10px;
    }
    .images img{
      width: 260px;
      max-width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: .15s ease;
    }
    .images img:hover{ transform: scale(1.01); border-color: rgba(201,168,124,.55); }

    .text{
      font-size: 14px;
      line-height: 1.75;
      color: var(--text);
      word-break: break-word;
      white-space: pre-wrap;
    }
    .text code{
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 2px 6px;
      border-radius: 8px;
      color: #f0abfc;
    }
    .text pre{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:auto;
      margin: 12px 0;
      background: #0d1117;
    }
    .text pre code{
      display:block;
      padding: 14px;
      background: #0d1117;
      border: none;
      color: #e5e7eb;
    }

    .typing{
      display:flex;
      gap: 10px;
      align-items:center;
      color: var(--muted2);
      font-size: 13px;
      user-select:none;
    }
    .dots{ display:flex; gap:4px; }
    .dots span{
      width:7px; height:7px;
      background: var(--accent);
      border-radius:999px;
      animation: bounce 1.1s infinite ease-in-out;
      opacity:.7;
    }
    .dots span:nth-child(2){ animation-delay:.12s; }
    .dots span:nth-child(3){ animation-delay:.24s; }
    @keyframes bounce{ 0%,60%,100%{ transform:none; opacity:.5 } 30%{ transform: translateY(-6px); opacity:1 } }

    .composer{
      padding: 14px 16px 18px;
      border-top: 1px solid var(--border);
      background: linear-gradient(to top, rgba(11,11,13,.98) 70%, rgba(11,11,13,.20));
    }
    .composer-inner{
      max-width: 860px;
      margin: 0 auto;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .composer-inner:focus-within{
      border-color: rgba(201,168,124,.55);
      box-shadow: var(--shadow), 0 0 0 3px rgba(201,168,124,.12);
    }

    .preview{
      display:none;
      gap:10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .preview.active{ display:flex; }
    .preview-item{
      position: relative;
      width:72px; height:72px;
      border-radius:14px;
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .preview-item img{ width:100%; height:100%; object-fit: cover; display:block; cursor:pointer; }
    .preview-remove{
      position:absolute;
      top:-8px; right:-8px;
      width:24px; height:24px;
      border-radius:999px;
      border: 2px solid rgba(11,11,13,.9);
      background: var(--err);
      color:#0b0b0d;
      font-weight:900;
      cursor:pointer;
    }

    .row{ display:flex; gap:10px; align-items:flex-end; }
    textarea{
      flex:1;
      border:none;
      outline:none;
      resize:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      min-height: 24px;
      max-height: 160px;
      padding: 2px 0;
    }
    textarea::placeholder{ color: var(--muted2); }

    .iconbtn{
      width: 42px; height:42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--muted);
      cursor:pointer;
      transition: .15s ease;
      user-select:none;
    }
    .iconbtn:hover{ background: rgba(255,255,255,.06); border-color: var(--border2); color: var(--text); }

    .send{
      width:42px; height:42px;
      border-radius:14px;
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0b0b0d;
      font-weight:900;
      cursor:pointer;
      transition:.15s ease;
    }
    .send:hover{ transform: translateY(-1px); }
    .send:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Artifacts card */
    .artifactCard{
      margin-top:12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .artifactHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .artifactName{
      display:flex; align-items:center; gap:10px;
      font-weight:700; font-size:12px;
    }
    .bolt{
      width:22px; height:22px;
      border-radius:8px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--purple), #7c3aed);
      color:#0b0b0d;
      font-weight:900;
      user-select:none;
    }
    .artifactBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .artifactBody{ height:230px; background:#fff; }
    .artifactBody iframe{ width:100%; height:100%; border:none; }

    /* Side panel */
    .side{
      width: 0;
      border-left: 1px solid var(--border);
      background: rgba(16,16,20,.92);
      backdrop-filter: blur(10px);
      overflow:hidden;
      transition: width .22s ease;
      display:flex;
      flex-direction:column;
    }
    .side.open{ width: min(52vw, 620px); }
    .sideHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(21,21,27,.9);
    }
    .sideTitle{
      font-weight:700; font-size:13px;
      display:flex; align-items:center; gap:10px;
    }
    .sideTabs{ display:flex; gap:6px; align-items:center; }
    .tab{
      padding: 8px 10px;
      border-radius:10px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
    }
    .tab:hover{ background: rgba(255,255,255,.06); }
    .tab.active{ background: rgba(255,255,255,.08); border-color: var(--border); color: var(--text); }

    .xbtn{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-size: 18px;
    }
    .xbtn:hover{ background: rgba(255,255,255,.06); color: var(--text); }

    .sideBody{ flex:1; overflow:hidden; display:flex; flex-direction:column; }
    .codeview, .previewview{ flex:1; overflow:auto; display:none; }
    .codeview.active{ display:block; }
    .previewview.active{ display:block; background:#fff; }
    .codeview pre{ margin:0; min-height:100%; background:#0d1117; }
    .codeview code{ display:block; padding:14px; font-family:"JetBrains Mono", monospace; font-size:13px; line-height:1.6; color:#e5e7eb; white-space: pre; }
    .previewview iframe{ width:100%; height:100%; border:none; }

    .sideActions{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      display:flex;
      gap:10px;
      background: rgba(21,21,27,.9);
    }
    .sideActions button{
      flex:1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
    }
    .sideActions button:hover{ background: rgba(255,255,255,.08); border-color: var(--border2); }
    .sideActions button.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#0b0b0d;
      font-weight:800;
    }

    /* Diagnostics */
    .diag{
      max-width: 860px;
      margin: 10px auto 0;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      display:none;
    }
    .diag.show{ display:block; }
    .diag pre{
      margin-top: 8px;
      padding: 10px;
      border-radius: 12px;
      background: #0d1117;
      border: 1px solid rgba(255,255,255,.10);
      color: #e5e7eb;
      overflow:auto;
      max-height: 180px;
      font-family: "JetBrains Mono", monospace;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.92);
      z-index:999;
      padding: 30px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:100%;
      max-height:100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      object-fit: contain;
    }
    .modal button{
      position:absolute;
      top: 18px; right: 18px;
      width: 44px; height:44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-size: 18px;
    }

    /* Drop overlay */
    .drop{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 10px;
      background: rgba(11,11,13,.92);
      border: 2px dashed rgba(201,168,124,.5);
      z-index:900;
    }
    .drop.active{ display:flex; }
    .drop .big{ font-size: 44px; }
    .drop .t{ font-size: 16px; color: var(--muted); }

    @media (max-width: 980px){
      .side.open{ width: 100vw; position: fixed; inset:0; z-index: 800; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="main">
      <div class="header">
        <div class="brand">
          <div class="badge">‚ú¶</div>
          <div>Claude AI</div>
        </div>

        <div class="controls">
          <div class="pill" title="Status">
            <span class="dot" id="statusDot"></span>
            <span id="statusLabel">Ready</span>
          </div>

          <div class="pill" title="Mode">
            <span class="dot" id="modeDot"></span>
            <span id="modeLabel">Chat</span>
          </div>

          <select id="modelSelect" title="Model">
            <option value="claude-opus-4-5">Claude Opus 4.5</option>
            <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5</option>
            <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
            <option value="gpt-4o">GPT-4o (backup)</option>
          </select>

          <button class="btn" id="newBtn" type="button">New</button>
        </div>
      </div>

      <div class="banner" id="banner"></div>

      <div class="diag" id="diag">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
          <div style="color:var(--muted);font-size:12px;"><strong>Diagnostics</strong></div>
          <button class="btn" id="clearLogsBtn" type="button" style="padding:8px 10px;">Clear</button>
        </div>
        <pre id="diagLog"></pre>
      </div>

      <div class="chat" id="chat">
        <div class="welcome" id="welcome">
          <h1>Fixed build ‚Äî no placeholders, no syntax traps.</h1>
          <p>
            If Send ever ‚Äúdoes nothing‚Äù, it‚Äôs almost always Puter auth blocked by popups/shields.
            The page will auto-detect and show a banner.
          </p>
          <p style="margin-top:8px;color:var(--muted2);font-size:13px;">
            Tip: try model <b>GPT-4o (backup)</b> if a Claude model is flaky.
          </p>
        </div>
      </div>

      <div class="composer">
        <div class="composer-inner" id="composerBox">
          <div class="preview" id="preview"></div>
          <div class="row">
            <textarea id="input" rows="1" placeholder="Message Claude‚Ä¶ (Enter to send, Shift+Enter newline)"></textarea>
            <button class="iconbtn" id="imageBtn" type="button" title="Upload image">üì∑</button>
            <button class="send" id="sendBtn" type="button" title="Send">‚û§</button>
          </div>
        </div>
        <input id="fileInput" type="file" accept="image/*" hidden />
      </div>
    </div>

    <aside class="side" id="side">
      <div class="sideHead">
        <div class="sideTitle"><span class="bolt">‚ö°</span><span id="artifactTitle">Artifact</span></div>
        <div class="sideTabs">
          <button class="tab active" id="tabCode" type="button">Code</button>
          <button class="tab" id="tabPrev" type="button">Preview</button>
        </div>
        <button class="xbtn" id="closeSide" type="button">√ó</button>
      </div>

      <div class="sideBody">
        <div class="codeview active" id="codeView"><pre><code id="artifactCode"></code></pre></div>
        <div class="previewview" id="prevView"><iframe id="artifactFrame" sandbox="allow-scripts"></iframe></div>
      </div>

      <div class="sideActions">
        <button id="copyArtifact" type="button">Copy</button>
        <button id="downloadArtifact" type="button">Download</button>
        <button class="primary" id="openArtifact" type="button">Open</button>
      </div>
    </aside>
  </div>

  <div class="drop" id="drop">
    <div class="big">üì∑</div>
    <div class="t">Drop image to upload</div>
  </div>

  <div class="modal" id="modal">
    <button id="closeModal" type="button">√ó</button>
    <img id="modalImg" alt="image" />
  </div>

  <script>
    // ======================
    // Self-healing core
    // ======================
    const state = {
      busy: false,
      pendingFile: null,
      pendingUrl: null,
      displayedUrls: [],
      history: [],
      artifacts: new Map(),
      currentArtifactId: null,
      logs: [],
      lastSendAt: 0,
      requestId: 0,
      firstGestureArmed: true,
      puterInjected: false
    };

    const $ = (id) => document.getElementById(id);

    const chatEl = $('chat');
    const welcomeEl = $('welcome');
    const inputEl = $('input');
    const sendBtn = $('sendBtn');
    const imageBtn = $('imageBtn');
    const fileInput = $('fileInput');
    const previewEl = $('preview');
    const modelSelect = $('modelSelect');

    const statusDot = $('statusDot');
    const statusLabel = $('statusLabel');
    const modeDot = $('modeDot');
    const modeLabel = $('modeLabel');

    const banner = $('banner');
    const diag = $('diag');
    const diagLog = $('diagLog');
    const clearLogsBtn = $('clearLogsBtn');

    const side = $('side');
    const artifactTitle = $('artifactTitle');
    const artifactCode = $('artifactCode');
    const artifactFrame = $('artifactFrame');
    const codeView = $('codeView');
    const prevView = $('prevView');
    const tabCode = $('tabCode');
    const tabPrev = $('tabPrev');
    const closeSide = $('closeSide');
    const copyArtifact = $('copyArtifact');
    const downloadArtifact = $('downloadArtifact');
    const openArtifact = $('openArtifact');

    const drop = $('drop');
    const modal = $('modal');
    const modalImg = $('modalImg');
    const closeModal = $('closeModal');

    const newBtn = $('newBtn');

    const CODING_SYSTEM = `
You are a top-tier coding assistant.
If the user asks for a website/app UI/code, respond with a complete working artifact.

Use this exact format:
\`\`\`artifact:html
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>...</title>
  <style>/* full CSS */</style>
</head>
<body>
  <!-- full HTML -->
  <script>/* full JS if needed */</script>
</body>
</html>
\`\`\`

Rules:
- Always include full HTML (CSS + JS if needed).
- Make it polished, responsive, modern.
- Do NOT leave "..." in important parts.
`.trim();

    const VISION_SYSTEM = `
You are an advanced vision assistant.
Be accurate and detailed.
If there is text, transcribe it exactly.
If unsure, say what is unclear.
`.trim();

    function log(msg, obj) {
      const line = `[${new Date().toISOString()}] ${msg}` + (obj ? `\n${safeStringify(obj)}` : '');
      state.logs.push(line);
      if (state.logs.length > 200) state.logs.shift();
      diagLog.textContent = state.logs.join('\n\n');
    }
    function safeStringify(x) {
      try { return typeof x === 'string' ? x : JSON.stringify(x, null, 2); }
      catch { return String(x); }
    }

    function showBanner(html) {
      banner.innerHTML = html;
      banner.classList.add('show');
    }
    function hideBanner() {
      banner.classList.remove('show');
      banner.innerHTML = '';
    }

    function setStatus(kind, text) {
      statusDot.className = 'dot';
      if (kind === 'warn') statusDot.classList.add('warn');
      if (kind === 'err') statusDot.classList.add('err');
      statusLabel.textContent = text;
    }

    function setMode(mode) {
      modeDot.className = 'dot';
      if (mode === 'vision') modeDot.classList.add('vision');
      modeLabel.textContent = mode === 'vision' ? 'Vision' : 'Chat';
    }

    function autosize() {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
    }

    function scrollToBottom() { chatEl.scrollTop = chatEl.scrollHeight; }

    function escapeHtml(s) {
      return (s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function withTimeout(promise, ms) {
      return new Promise((resolve, reject) => {
        const t = setTimeout(() => reject(new Error('Request timed out. Check popups/shields.')), ms);
        promise.then(v => { clearTimeout(t); resolve(v); })
               .catch(e => { clearTimeout(t); reject(e); });
      });
    }

    function extractText(res) {
      if (res == null) return '';
      if (typeof res === 'string') return res;
      const c = res?.message?.content;
      if (Array.isArray(c)) {
        return c.filter(b => b?.type === 'text' && typeof b?.text === 'string')
                .map(b => b.text).join('\n').trim();
      }
      if (typeof c === 'string') return c;
      if (typeof res?.text === 'string') return res.text;
      if (typeof res?.content === 'string') return res.content;
      return safeStringify(res);
    }

    function nowTime() {
      return new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
    }

    function addMessage({ name, avatar, ai, text, imageUrls = [] }) {
      welcomeEl.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = 'msg';

      const av = document.createElement('div');
      av.className = 'avatar' + (ai ? ' ai' : '');
      av.textContent = avatar;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span class="name">${escapeHtml(name)}</span><span>${escapeHtml(nowTime())}</span>`;

      const images = document.createElement('div');
      images.className = 'images';
      if (imageUrls.length) {
        for (const url of imageUrls) {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'image';
          img.addEventListener('click', () => openModal(url));
          images.appendChild(img);
        }
      }

      const content = document.createElement('div');
      content.className = 'text';
      content.textContent = text || '';

      bubble.appendChild(meta);
      if (imageUrls.length) bubble.appendChild(images);
      bubble.appendChild(content);

      msg.appendChild(av);
      msg.appendChild(bubble);

      chatEl.appendChild(msg);
      scrollToBottom();
      return content;
    }

    function addTyping() {
      const el = addMessage({ name:'Claude', avatar:'‚ú¶', ai:true, text:'' });
      el.dataset.typing = '1';
      el.innerHTML = `<div class="typing"><div class="dots"><span></span><span></span><span></span></div><div>Thinking‚Ä¶</div></div>`;
    }

    function removeTyping() {
      const el = chatEl.querySelector('[data-typing="1"]');
      if (el) el.closest('.msg').remove();
    }

    // ===== Artifacts =====
    function splitArtifacts(text) {
      const out = [];
      const re = /```artifact:(\w+)\n([\s\S]*?)```/g;
      let last = 0, m;
      while ((m = re.exec(text)) !== null) {
        const before = text.slice(last, m.index);
        if (before.trim()) out.push({ kind:'text', value: before });

        out.push({ kind:'artifact', type: (m[1]||'').toLowerCase(), code: (m[2]||'').trim() });
        last = m.index + m[0].length;
      }
      const rest = text.slice(last);
      if (rest.trim()) out.push({ kind:'text', value: rest });
      return out.length ? out : [{ kind:'text', value: text }];
    }

    function renderAssistant(el, fullText) {
      el.innerHTML = '';
      const segs = splitArtifacts(fullText || '');

      for (const s of segs) {
        if (s.kind === 'text') {
          const div = document.createElement('div');
          // safe inline-code formatting
          const safe = escapeHtml(s.value).replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, '<br>');
          div.innerHTML = safe;
          el.appendChild(div);
        } else {
          const id = (crypto?.randomUUID?.() ?? String(Date.now() + Math.random()));
          const name = `${s.type.toUpperCase()} Artifact`;
          state.artifacts.set(id, { id, type: s.type, code: s.code, name });
          state.currentArtifactId = id;

          const card = document.createElement('div');
          card.className = 'artifactCard';

          const head = document.createElement('div');
          head.className = 'artifactHead';

          const left = document.createElement('div');
          left.className = 'artifactName';
          left.innerHTML = `<span class="bolt">‚ö°</span><span>${escapeHtml(name)}</span>`;

          const btns = document.createElement('div');
          btns.className = 'artifactBtns';
          btns.innerHTML = `
            <button class="btn" type="button" data-action="artifact-open" data-id="${id}" style="padding:7px 10px;font-size:12px;">Open</button>
            <button class="btn" type="button" data-action="artifact-copy" data-id="${id}" style="padding:7px 10px;font-size:12px;">Copy</button>
            <button class="btn" type="button" data-action="artifact-download" data-id="${id}" style="padding:7px 10px;font-size:12px;">Download</button>
          `;

          head.appendChild(left);
          head.appendChild(btns);

          const body = document.createElement('div');
          body.className = 'artifactBody';

          const iframe = document.createElement('iframe');
          iframe.sandbox = 'allow-scripts';
          iframe.srcdoc = (s.type === 'html' || s.type === 'htm')
            ? s.code
            : `<pre style="white-space:pre-wrap;padding:14px;font-family:ui-monospace,monospace;">${escapeHtml(s.code)}</pre>`;
          body.appendChild(iframe);

          card.appendChild(head);
          card.appendChild(body);
          el.appendChild(card);
        }
      }
    }

    function showTab(which) {
      if (which === 'code') {
        tabCode.classList.add('active');
        tabPrev.classList.remove('active');
        codeView.classList.add('active');
        prevView.classList.remove('active');
      } else {
        tabCode.classList.remove('active');
        tabPrev.classList.add('active');
        codeView.classList.remove('active');
        prevView.classList.add('active');
      }
    }

    function openArtifactPanel(id) {
      const a = state.artifacts.get(id);
      if (!a) return;
      state.currentArtifactId = id;

      artifactTitle.textContent = a.name;
      artifactCode.textContent = a.code;
      artifactFrame.srcdoc = (a.type === 'html' || a.type === 'htm')
        ? a.code
        : `<pre style="white-space:pre-wrap;padding:14px;font-family:ui-monospace,monospace;">${escapeHtml(a.code)}</pre>`;

      side.classList.add('open');
      showTab('code');
    }

    function closeArtifactPanel() { side.classList.remove('open'); }

    async function copyCurrentArtifact() {
      const a = state.artifacts.get(state.currentArtifactId);
      if (!a) return;
      await navigator.clipboard.writeText(a.code);
      setStatus('ok', 'Copied');
      setTimeout(() => setStatus('ok', 'Ready'), 700);
    }

    function downloadCurrentArtifact() {
      const a = state.artifacts.get(state.currentArtifactId);
      if (!a) return;
      const ext = a.type === 'html' ? 'html' : a.type;
      const blob = new Blob([a.code], { type:'text/plain' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `artifact.${ext}`;
      link.click();
      URL.revokeObjectURL(url);
    }

    function openCurrentArtifactNewTab() {
      const a = state.artifacts.get(state.currentArtifactId);
      if (!a) return;
      const w = window.open('', '_blank', 'noopener,noreferrer');
      w.document.open();
      w.document.write(a.code);
      w.document.close();
    }

    // ===== Modal =====
    function openModal(src) { modalImg.src = src; modal.classList.add('active'); }
    function closeModalFn() { modal.classList.remove('active'); modalImg.src = ''; }

    // ===== Puter loader (auto-repair if blocked) =====
    function ensurePuterLoaded() {
      if (window.puter && puter.ai && typeof puter.ai.chat === 'function') return true;

      // try re-inject once (adblock/shields might still block)
      if (!state.puterInjected) {
        state.puterInjected = true;
        const s = document.createElement('script');
        s.src = 'https://js.puter.com/v2/';
        s.async = true;
        s.onload = () => log('Re-injected Puter.js loaded');
        s.onerror = () => log('Re-injected Puter.js failed to load');
        document.head.appendChild(s);
      }

      return false;
    }

    // ===== One-time image attach =====
    function clearPendingImage() {
      if (state.pendingUrl) {
        try { URL.revokeObjectURL(state.pendingUrl); } catch {}
      }
      state.pendingFile = null;
      state.pendingUrl = null;
      previewEl.classList.remove('active');
      previewEl.innerHTML = '';
      setMode('chat');
    }

    function setPendingImage(file) {
      if (!file || !file.type || !file.type.startsWith('image/')) return;

      clearPendingImage();
      state.pendingFile = file;
      state.pendingUrl = URL.createObjectURL(file);

      previewEl.classList.add('active');
      previewEl.innerHTML = '';

      const item = document.createElement('div');
      item.className = 'preview-item';

      const img = document.createElement('img');
      img.src = state.pendingUrl;
      img.alt = 'preview';
      img.addEventListener('click', () => openModal(state.pendingUrl));

      const rm = document.createElement('button');
      rm.className = 'preview-remove';
      rm.type = 'button';
      rm.textContent = '√ó';
      rm.addEventListener('click', clearPendingImage);

      item.appendChild(img);
      item.appendChild(rm);
      previewEl.appendChild(item);

      setMode('vision');
    }

    async function fileToBase64Parts(file) {
      const dataUrl = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(new Error('Failed to read image file'));
        r.readAsDataURL(file);
      });

      const m = String(dataUrl).match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.+)$/);
      if (!m) throw new Error('Invalid image encoding');
      return { media_type: m[1], data: m[2] };
    }

    // ===== Calls (non-stream) =====
    async function callText(model, userText) {
      state.history.push({ role:'user', content: userText });

      const recent = state.history.slice(-12)
        .map(m => `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`)
        .join('\n');

      const prompt =
`${CODING_SYSTEM}

Conversation (recent):
${recent}

Now respond to the user's latest message.`;

      const res = await withTimeout(puter.ai.chat(prompt, { model, stream:false }), 45000);
      const txt = extractText(res);
      state.history.push({ role:'assistant', content: txt });
      return txt;
    }

    async function callVision(model, userText, file) {
      const parts = await fileToBase64Parts(file);
      const content = [
        {
          type: 'image',
          source: { type:'base64', media_type: parts.media_type, data: parts.data }
        },
        {
          type: 'text',
          text: `${VISION_SYSTEM}\n\nUser request:\n${userText || 'Analyze this image.'}`
        }
      ];

      const res = await withTimeout(
        puter.ai.chat([{ role:'user', content }], { model, stream:false }),
        45000
      );
      return extractText(res);
    }

    // ===== Auto-heal watchdog =====
    function heal(reason) {
      log('HEAL: ' + reason);
      state.busy = false;
      sendBtn.disabled = false;
      removeTyping();
      setStatus('warn', 'Recovered');
    }

    setInterval(() => {
      if (state.busy && Date.now() - state.lastSendAt > 25000) {
        heal('auto watchdog (stuck busy)');
        showBanner(`<strong>Auto repaired:</strong> the request got stuck. If it keeps happening, popups/shields are blocking Puter login.`);
      }
    }, 2000);

    // ===== First user gesture auto-connect attempt =====
    function firstGestureConnect() {
      if (!state.firstGestureArmed) return;
      state.firstGestureArmed = false;

      // Only attempt if Puter exists; if not, banner will show
      if (!ensurePuterLoaded()) {
        showBanner(`<strong>Puter.js blocked:</strong> disable adblock/shields for this site, then reload.`);
        setStatus('err', 'Blocked');
        log('Puter missing on first gesture');
        return;
      }

      // Small call to trigger login if needed
      const model = modelSelect.value || 'claude-haiku-4-5';
      log('Auto-connect attempt via first gesture');
      setStatus('warn', 'Connecting‚Ä¶');

      withTimeout(puter.ai.chat('Say "connected".', { model, stream:false }), 20000)
        .then(res => {
          log('Auto-connect ok', extractText(res));
          setStatus('ok', 'Ready');
          hideBanner();
        })
        .catch(e => {
          log('Auto-connect failed', e);
          setStatus('err', 'Auth blocked');
          showBanner(`<strong>Auth blocked:</strong> allow popups for Puter login / disable Brave Shields, then try Send again.`);
        });
    }

    window.addEventListener('pointerdown', firstGestureConnect, { once: true });

    // ===== Send =====
    async function send() {
      hideBanner();

      if (!ensurePuterLoaded()) {
        setStatus('err', 'Blocked');
        showBanner(`<strong>Puter.js blocked:</strong> disable adblock/shields and reload. (Open Diagnostics for details.)`);
        log('Send failed: Puter missing');
        return;
      }

      if (state.busy) {
        showBanner(`<strong>Busy:</strong> already sending. If it looks stuck, it will auto-repair.`);
        return;
      }

      const model = modelSelect.value;
      const text = inputEl.value.trim();
      const hasImage = !!state.pendingFile;

      if (!text && !hasImage) return;

      state.busy = true;
      sendBtn.disabled = true;
      state.lastSendAt = Date.now();
      const myReq = ++state.requestId;

      setStatus('warn', 'Sending‚Ä¶');

      // show user message immediately
      const shownText = text || (hasImage ? 'Analyze this image.' : '');
      const imgUrls = state.pendingUrl ? [state.pendingUrl] : [];
      if (imgUrls.length) state.displayedUrls.push(imgUrls[0]);

      addMessage({ name:'You', avatar:'üë§', ai:false, text: shownText, imageUrls: imgUrls });

      // clear input
      inputEl.value = '';
      autosize();

      // one-time image: capture file then clear attach UI
      const fileForThisRequest = state.pendingFile;
      if (hasImage) {
        state.pendingFile = null;
        state.pendingUrl = null;
        previewEl.classList.remove('active');
        previewEl.innerHTML = '';
        setMode('chat');
      }

      addTyping();

      try {
        const assistantEl = addMessage({ name:'Claude', avatar:'‚ú¶', ai:true, text:'' });

        let answer = '';
        if (fileForThisRequest) answer = await callVision(model, shownText, fileForThisRequest);
        else answer = await callText(model, shownText);

        // ignore if a newer request started
        if (myReq !== state.requestId) {
          log('Ignored late response for request ' + myReq);
          return;
        }

        removeTyping();
        renderAssistant(assistantEl, answer || '(No text returned.)');

        setStatus('ok', 'Ready');
      } catch (e) {
        if (myReq !== state.requestId) return;

        removeTyping();
        log('Send error', e);

        const errEl = addMessage({ name:'Claude', avatar:'‚ú¶', ai:true, text:'' });
        errEl.innerHTML =
          `<div style="padding:10px;border:1px solid rgba(251,113,133,.35);border-radius:12px;background:rgba(251,113,133,.08);color:#fecdd3;">
            <b>Error:</b> ${escapeHtml(e?.message || String(e))}<br><br>
            Most common fix: allow popups for Puter login / disable Brave Shields.
          </div>`;

        setStatus('err', 'Failed');
        heal('send catch');
      } finally {
        state.busy = false;
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }

    // ===== New chat =====
    function newChat() {
      for (const u of state.displayedUrls) { try { URL.revokeObjectURL(u); } catch {} }
      state.displayedUrls = [];
      state.history = [];
      state.artifacts.clear();
      state.currentArtifactId = null;
      clearPendingImage();
      closeArtifactPanel();

      chatEl.innerHTML = '';
      chatEl.appendChild(welcomeEl);
      welcomeEl.style.display = '';
      inputEl.value = '';
      autosize();

      hideBanner();
      setStatus('ok', 'Ready');
      setMode('chat');
      log('New chat');
    }

    // ===== Diagnostics toggle =====
    function toggleDiag() { diag.classList.toggle('show'); }

    // ======================
    // Event wiring
    // ======================
    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('input', autosize);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    imageBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) setPendingImage(f);
      fileInput.value = '';
    });

    // paste image
    document.addEventListener('paste', (e) => {
      const items = Array.from(e.clipboardData?.items || []);
      const img = items.find(it => it.type && it.type.startsWith('image/'));
      if (!img) return;
      e.preventDefault();
      setPendingImage(img.getAsFile());
    });

    // drag drop
    let dragCounter = 0;
    document.addEventListener('dragenter', (e) => { e.preventDefault(); dragCounter++; drop.classList.add('active'); });
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('dragleave', (e) => { e.preventDefault(); dragCounter = Math.max(0, dragCounter - 1); if (!dragCounter) drop.classList.remove('active'); });
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      dragCounter = 0;
      drop.classList.remove('active');
      const f = e.dataTransfer?.files?.[0];
      if (f) setPendingImage(f);
    });

    // artifacts click (delegation)
    chatEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (!id) return;

      if (action === 'artifact-open') openArtifactPanel(id);
      if (action === 'artifact-copy') {
        const a = state.artifacts.get(id);
        if (!a) return;
        await navigator.clipboard.writeText(a.code);
        setStatus('ok', 'Copied');
        setTimeout(() => setStatus('ok', 'Ready'), 700);
      }
      if (action === 'artifact-download') {
        state.currentArtifactId = id;
        downloadCurrentArtifact();
      }
    });

    closeSide.addEventListener('click', closeArtifactPanel);
    tabCode.addEventListener('click', () => showTab('code'));
    tabPrev.addEventListener('click', () => showTab('preview'));
    copyArtifact.addEventListener('click', copyCurrentArtifact);
    downloadArtifact.addEventListener('click', downloadCurrentArtifact);
    openArtifact.addEventListener('click', openCurrentArtifactNewTab);

    closeModal.addEventListener('click', closeModalFn);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModalFn(); });

    clearLogsBtn.addEventListener('click', () => { state.logs = []; diagLog.textContent = ''; });

    $('diagLog').addEventListener?.('dblclick', toggleDiag);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModalFn(); closeArtifactPanel(); } });

    $('diagLog'); // keep linter calm

    $('diagBtn')?.addEventListener?.('click', toggleDiag); // if you add a diag button later

    newBtn.addEventListener('click', newChat);

    // init
    autosize();
    setStatus('ok', 'Ready');
    setMode('chat');
    inputEl.focus();

    // If Puter is blocked, tell user immediately
    if (!ensurePuterLoaded()) {
      setStatus('warn', 'Waiting');
      showBanner(`<strong>Puter.js not available:</strong> likely blocked by adblock/shields. Disable it for this site and reload.`);
      log('Puter missing at init');
    } else {
      log('App loaded');
    }
  </script>
</body>
        </html>
