<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Claude Vision (Puter)</title>

  <script src="https://js.puter.com/v2/"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b0b0d;
      --panel: #111114;
      --panel2:#15151a;
      --border:#26262d;
      --text:#e9e9ef;
      --muted:#a1a1b3;
      --muted2:#707085;
      --accent:#d4a574;
      --accent2:#e6c29a;
      --danger:#ff6b6b;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(212,165,116,.12), transparent 60%),
                  radial-gradient(1200px 800px at 90% 10%, rgba(128,90,213,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(14px);
      background: rgba(11,11,13,.75);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{
      max-width: 920px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .brand-badge{
      width: 34px; height:34px; border-radius: 10px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, var(--accent), #b98257);
      color:#141414;
      font-weight:900;
    }
    .controls{
      display:flex; align-items:center; gap:10px;
    }
    select{
      appearance:none;
      background: var(--panel2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      outline: none;
    }
    select:hover{ border-color: rgba(212,165,116,.55); }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 16px 24px;
      height: calc(100% - 64px);
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .chat{
      flex:1;
      overflow:auto;
      padding: 6px 0 18px;
    }

    .welcome{
      margin-top: 40px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border-radius: 18px;
      padding: 22px;
    }
    .welcome h1{ margin: 0 0 10px; font-size: 22px; }
    .welcome p{ margin: 0; color: var(--muted); line-height: 1.55; font-size: 14px; }

    .msg{
      margin: 18px 0;
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }
    .avatar{
      width: 34px; height:34px;
      border-radius: 11px;
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight: 800;
      user-select:none;
    }
    .avatar.assistant{
      background: linear-gradient(135deg, rgba(212,165,116,.95), rgba(185,130,87,.95));
      color:#131313;
      border-color: rgba(212,165,116,.35);
    }
    .bubble{ flex: 1 1 auto; min-width: 0; }
    .meta{
      font-size: 12px;
      color: var(--muted2);
      margin-bottom: 6px;
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content: space-between;
    }
    .meta .name{
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
    }
    .content{
      line-height: 1.75;
      font-size: 14px;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .content code{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 2px 6px;
      border-radius: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 13px;
    }
    .content pre{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
      padding: 12px;
      border-radius: 14px;
      overflow:auto;
    }

    .images-row{
      display:flex; flex-wrap:wrap; gap: 10px;
      margin: 10px 0 8px;
    }
    .thumb{
      width: 220px;
      max-width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      object-fit: cover;
      cursor: pointer;
    }

    .composer{
      position: sticky;
      bottom: 0;
      padding-top: 10px;
      background: linear-gradient(180deg, transparent, rgba(11,11,13,.85) 30%, rgba(11,11,13,.95));
    }
    .composer-box{
      border: 1px solid var(--border);
      background: rgba(17,17,20,.9);
      border-radius: 18px;
      padding: 14px;
    }
    .composer-box:focus-within{
      border-color: rgba(212,165,116,.55);
      box-shadow: 0 0 0 3px rgba(212,165,116,.10);
    }

    .preview{
      display:none;
      gap: 10px;
      flex-wrap: wrap;
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .preview.active{ display:flex; }
    .preview-item{
      position: relative;
      width: 76px;
      height: 76px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .preview-item img{ width: 100%; height:100%; object-fit: cover; display:block; }
    .preview-remove{
      position:absolute; top: -8px; right:-8px;
      width: 24px; height: 24px;
      border-radius: 999px;
      border:none;
      background: var(--danger);
      color: #121212;
      font-weight: 900;
      cursor:pointer;
    }

    .row{ display:flex; gap: 10px; align-items:flex-end; }
    textarea{
      flex: 1 1 auto;
      background: transparent;
      border: none;
      color: var(--text);
      resize: none;
      outline: none;
      font-size: 14px;
      line-height: 1.5;
      min-height: 24px;
      max-height: 180px;
      padding: 2px 0;
    }
    textarea::placeholder{ color: var(--muted2); }

    .btn{
      width: 44px; height:44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-size: 18px;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(212,165,116,.55); }
    .btn-send{
      background: linear-gradient(135deg, var(--accent), #b98257);
      border-color: rgba(212,165,116,.50);
      color:#121212;
      font-weight: 900;
    }
    .btn-send:disabled{ opacity: .55; cursor:not-allowed; }

    .hint{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap:wrap;
      align-items: center;
    }
    .hint b{ color: var(--muted); font-weight:600; }

    /* Small toggle (not ‚Äúmany options‚Äù) */
    .toggle{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); }

    .drop-overlay{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      background: rgba(11,11,13,.92);
      z-index: 100;
      border: 2px dashed rgba(212,165,116,.45);
    }
    .drop-overlay.active{ display:flex; }
    .drop-overlay .big{ font-size: 44px; margin-bottom: 10px; }
    .drop-overlay .txt{ font-size: 16px; color: var(--muted); }

    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.92);
      z-index: 120;
      padding: 24px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width: 100%;
      max-height: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.15);
      object-fit: contain;
    }
    .modal button{
      position:absolute;
      top: 18px; right: 18px;
      width: 46px; height:46px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 20px;
      cursor:pointer;
    }

    @media (max-width: 700px){
      .thumb{ width: 100%; }
      .topbar-inner{ padding: 12px 12px; }
      .wrap{ padding: 14px 12px 18px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="brand-badge">‚ú¶</div>
        <div>Claude Vision</div>
      </div>

      <div class="controls">
        <select id="modelSelect" title="Model">
          <option value="claude-opus-4-5">Claude Opus 4.5</option>
          <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5</option>
          <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
          <option value="gpt-4o">GPT-4o (backup)</option>
        </select>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="chat" class="chat">
      <div class="welcome" id="welcome">
        <h1>Ultra-detail image understanding</h1>
        <p>
          This version sends <b>the full image + zoomed crops</b> so the model can catch tiny text and small objects.
          Upload/paste/drag an image, then ask.
        </p>
      </div>
    </div>

    <div class="composer">
      <div class="composer-box">
        <div id="preview" class="preview"></div>

        <div class="row">
          <textarea id="textInput" rows="1" placeholder="Ask about your image‚Ä¶ (Enter to send, Shift+Enter newline)"></textarea>
          <button id="imageBtn" class="btn" title="Image">üì∑</button>
          <button id="sendBtn" class="btn btn-send" title="Send">‚û§</button>
        </div>

        <div class="hint">
          <span><b>Tip:</b> upload the sharpest version you have</span>
          <label class="toggle" title="Sends full image + zoomed crops (slower but more detailed)">
            <input id="ultraToggle" type="checkbox" checked />
            Ultra detail
          </label>
        </div>
      </div>
    </div>

    <input id="fileInput" type="file" accept="image/*" hidden />
  </div>

  <div id="dropOverlay" class="drop-overlay">
    <div class="big">üì∑</div>
    <div class="txt">Drop your image here</div>
  </div>

  <div id="imgModal" class="modal" aria-hidden="true">
    <button id="closeModalBtn" title="Close">‚úï</button>
    <img id="modalImg" alt="preview" />
  </div>

  <script>
    const state = {
      pendingFile: null,          // single image (best for accuracy)
      pendingPreviewUrl: null,    // objectURL
      lastVisionDataUrls: null,   // { full, crops: [{label, dataUrl}], displayUrl }
      busy: false
    };

    const chatEl = document.getElementById('chat');
    const welcomeEl = document.getElementById('welcome');
    const previewEl = document.getElementById('preview');
    const textInputEl = document.getElementById('textInput');
    const imageBtnEl = document.getElementById('imageBtn');
    const sendBtnEl = document.getElementById('sendBtn');
    const fileInputEl = document.getElementById('fileInput');
    const modelSelectEl = document.getElementById('modelSelect');
    const dropOverlayEl = document.getElementById('dropOverlay');
    const ultraToggleEl = document.getElementById('ultraToggle');

    const imgModalEl = document.getElementById('imgModal');
    const modalImgEl = document.getElementById('modalImg');
    const closeModalBtnEl = document.getElementById('closeModalBtn');

    const VISION_SYSTEM = `
You are a highly accurate vision assistant.
Rules:
- Describe ONLY what you can actually see. If unsure, say "not clear" and ask a question.
- Use the provided zoomed crops to capture minute details.
- If text is visible, transcribe it exactly (preserve line breaks). Use [?] for unclear characters.
- Be specific: counts, colors, locations, small icons, logos, UI labels, tiny objects.
- Answer the user‚Äôs question FIRST, then give extra relevant details.
`.trim();

    function autosizeTextarea(){
      textInputEl.style.height = 'auto';
      textInputEl.style.height = Math.min(textInputEl.scrollHeight, 180) + 'px';
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

    function formatBasicMarkdownToHtml(text){
      let t = escapeHtml(text || '');

      // fenced code blocks
      t = t.replace(/```[\s\S]*?```/g, (m) => {
        const inner = m.slice(3, -3).replace(/^\w+\n/, '');
        return `<pre><code>${inner.trim()}</code></pre>`;
      });

      // inline code
      t = t.replace(/`([^`]+)`/g, '<code>$1</code>');

      // line breaks
      t = t.replace(/\n/g, '<br>');
      return t;
    }

    function addMessage({ role, text, imageUrls = [] }){
      welcomeEl.style.display = 'none';

      const msg = document.createElement('div');
      msg.className = 'msg';

      const avatar = document.createElement('div');
      avatar.className = 'avatar ' + (role === 'assistant' ? 'assistant' : 'user');
      avatar.textContent = role === 'assistant' ? '‚ú¶' : 'üë§';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<span class="name">${role === 'assistant' ? 'Claude' : 'You'}</span>`;

      const content = document.createElement('div');
      content.className = 'content';
      content.innerHTML = formatBasicMarkdownToHtml(text || '');

      bubble.appendChild(meta);

      if (imageUrls.length){
        const row = document.createElement('div');
        row.className = 'images-row';
        for (const url of imageUrls){
          const img = document.createElement('img');
          img.className = 'thumb';
          img.src = url;
          img.alt = 'image';
          img.addEventListener('click', () => openModal(url));
          row.appendChild(img);
        }
        bubble.appendChild(row);
      }

      bubble.appendChild(content);
      msg.appendChild(avatar);
      msg.appendChild(bubble);

      chatEl.appendChild(msg);
      chatEl.scrollTop = chatEl.scrollHeight;

      return { msg, contentEl: content };
    }

    function openModal(src){
      modalImgEl.src = src;
      imgModalEl.classList.add('active');
      imgModalEl.setAttribute('aria-hidden', 'false');
    }
    function closeModal(){
      imgModalEl.classList.remove('active');
      imgModalEl.setAttribute('aria-hidden', 'true');
      modalImgEl.src = '';
    }

    function renderPreview(){
      if (state.pendingPreviewUrl){
        URL.revokeObjectURL(state.pendingPreviewUrl);
        state.pendingPreviewUrl = null;
      }

      previewEl.innerHTML = '';
      if (!state.pendingFile){
        previewEl.classList.remove('active');
        return;
      }

      previewEl.classList.add('active');
      const url = URL.createObjectURL(state.pendingFile);
      state.pendingPreviewUrl = url;

      const item = document.createElement('div');
      item.className = 'preview-item';

      const img = document.createElement('img');
      img.src = url;
      img.alt = 'preview';
      img.addEventListener('click', () => openModal(url));

      const rm = document.createElement('button');
      rm.className = 'preview-remove';
      rm.textContent = '√ó';
      rm.addEventListener('click', () => {
        state.pendingFile = null;
        renderPreview();
      });

      item.appendChild(img);
      item.appendChild(rm);
      previewEl.appendChild(item);
    }

    async function addFile(file){
      if (!file || !file.type || !file.type.startsWith('image/')) return;
      state.pendingFile = file; // keep ONE image for max detail
      renderPreview();
    }

    // --- Image normalization + cropping ---
    async function fileToBitmap(file){
      try {
        return await createImageBitmap(file, { imageOrientation: 'from-image' });
      } catch {
        // fallback
        const dataUrl = await fileToDataUrl(file);
        const img = await dataUrlToImage(dataUrl);
        return img;
      }
    }

    function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(new Error('Failed reading file'));
        r.readAsDataURL(file);
      });
    }

    function dataUrlToImage(dataUrl){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to decode image'));
        img.src = dataUrl;
      });
    }

    function canvasToJpegDataUrl(canvas, quality = 0.95){
      return canvas.toDataURL('image/jpeg', quality);
    }

    function resizeToCanvas(drawable, maxSide = 2200){
      const srcW = drawable.width;
      const srcH = drawable.height;
      const scale = Math.min(1, maxSide / Math.max(srcW, srcH));
      const w = Math.max(1, Math.round(srcW * scale));
      const h = Math.max(1, Math.round(srcH * scale));

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d', { alpha:false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(drawable, 0, 0, w, h);
      return canvas;
    }

    function cropCanvasToDataUrl(srcCanvas, x, y, w, h, quality=0.95){
      const c = document.createElement('canvas');
      c.width = w;
      c.height = h;
      const ctx = c.getContext('2d', { alpha:false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(srcCanvas, x, y, w, h, 0, 0, w, h);
      return canvasToJpegDataUrl(c, quality);
    }

    function dataUrlToParts(dataUrl){
      const m = dataUrl.match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.+)$/);
      if (!m) throw new Error('Invalid image data URL');
      return { media_type: m[1], data: m[2] };
    }

    async function buildUltraVisionPack(file, ultra=true){
      const bmp = await fileToBitmap(file);
      const baseCanvas = resizeToCanvas(bmp, 2200);
      const full = canvasToJpegDataUrl(baseCanvas, 0.95);

      const W = baseCanvas.width;
      const H = baseCanvas.height;

      // crops for minute detail: 2x2 + center
      const crops = [];
      if (ultra){
        const halfW = Math.floor(W / 2);
        const halfH = Math.floor(H / 2);

        crops.push({ label: "CROP TL (top-left)", dataUrl: cropCanvasToDataUrl(baseCanvas, 0, 0, halfW, halfH) });
        crops.push({ label: "CROP TR (top-right)", dataUrl: cropCanvasToDataUrl(baseCanvas, halfW, 0, W - halfW, halfH) });
        crops.push({ label: "CROP BL (bottom-left)", dataUrl: cropCanvasToDataUrl(baseCanvas, 0, halfH, halfW, H - halfH) });
        crops.push({ label: "CROP BR (bottom-right)", dataUrl: cropCanvasToDataUrl(baseCanvas, halfW, halfH, W - halfW, H - halfH) });

        // center crop to catch small central details
        const cx = Math.floor(W * 0.25);
        const cy = Math.floor(H * 0.25);
        const cw = Math.floor(W * 0.5);
        const ch = Math.floor(H * 0.5);
        crops.push({ label: "CROP CENTER (zoom)", dataUrl: cropCanvasToDataUrl(baseCanvas, cx, cy, cw, ch) });
      }

      // for display, use the original file objectURL (clearer to user)
      const displayUrl = URL.createObjectURL(file);

      return { full, crops, displayUrl };
    }

    function makeImageBlock(dataUrl){
      const parts = dataUrlToParts(dataUrl);
      return {
        type: 'image',
        source: {
          type: 'base64',
          media_type: parts.media_type,
          data: parts.data
        }
      };
    }

    async function callModelWithVisionPack({ model, userText, pack, ultra }){
      const blocks = [];

      // label + full image
      blocks.push({ type: 'text', text: "[FULL IMAGE]" });
      blocks.push(makeImageBlock(pack.full));

      // label + crops
      if (ultra){
        for (const c of pack.crops){
          blocks.push({ type: 'text', text: `[${c.label}]` });
          blocks.push(makeImageBlock(c.dataUrl));
        }
      }

      const prompt =
`${VISION_SYSTEM}

USER REQUEST:
${userText || "Describe the image in ultra detail."}

OUTPUT REQUIREMENTS (IMPORTANT):
1) Answer the user directly first.
2) Then give a "Minute details" section: tiny objects/icons/logos/UI labels, small background items, subtle features.
   - When possible, cite where you saw it: FULL / TL / TR / BL / BR / CENTER.
3) "Text found" section: transcribe all visible text verbatim with line breaks. If unreadable: mark unclear characters as [?].
4) "Uncertain / needs closer crop" section: list anything you cannot confirm.

DO NOT GUESS. Use the crops to verify tiny details.`;

      blocks.push({ type: 'text', text: prompt });

      const messages = [{ role: 'user', content: blocks }];
      return await puter.ai.chat(messages, { model, stream: true });
    }

    async function callModelTextOnly({ model, userText }){
      return await puter.ai.chat(userText, { model, stream: true });
    }

    async function send(){
      if (state.busy) return;

      const userText = (textInputEl.value || '').trim();
      const ultra = !!ultraToggleEl.checked;

      const hasNewImage = !!state.pendingFile;
      const hasLastImage = !!state.lastVisionDataUrls;

      if (!userText && !hasNewImage && !hasLastImage) return;

      state.busy = true;
      sendBtnEl.disabled = true;

      // Determine which image pack to use:
      let pack = null;
      let displayUrl = null;

      if (hasNewImage){
        pack = await buildUltraVisionPack(state.pendingFile, ultra);
        // keep for follow-up questions without reupload
        state.lastVisionDataUrls = pack;

        displayUrl = pack.displayUrl;

        // clear composer image preview
        state.pendingFile = null;
        renderPreview();
      } else if (hasLastImage){
        pack = state.lastVisionDataUrls;
        displayUrl = pack.displayUrl; // old display url still valid; if user reloads page, it won‚Äôt persist anyway
      }

      // show user message
      addMessage({
        role: 'user',
        text: userText || (pack ? "Analyze this image in ultra detail." : "Hi"),
        imageUrls: pack ? [displayUrl] : []
      });

      textInputEl.value = '';
      autosizeTextarea();

      try {
        const model = modelSelectEl.value;

        const assistant = addMessage({ role: 'assistant', text: '' });
        let fullOut = '';

        const stream = pack
          ? await callModelWithVisionPack({ model, userText, pack, ultra })
          : await callModelTextOnly({ model, userText });

        for await (const part of stream){
          if (part?.text){
            fullOut += part.text;
            assistant.contentEl.innerHTML = formatBasicMarkdownToHtml(fullOut);
            chatEl.scrollTop = chatEl.scrollHeight;
          }
        }

        if (!fullOut.trim()){
          assistant.contentEl.innerHTML = formatBasicMarkdownToHtml(
            "I didn‚Äôt receive text output. Try again or switch models (e.g., GPT-4o backup)."
          );
        }
      } catch (err){
        addMessage({
          role: 'assistant',
          text:
`Error: ${err?.message || err}

If Claude vision is being weird, switch the model dropdown to **GPT-4o (backup)** and retry.`
        });
        console.error(err);
      } finally {
        state.busy = false;
        sendBtnEl.disabled = false;
        textInputEl.focus();
      }
    }

    // Events
    imageBtnEl.addEventListener('click', () => fileInputEl.click());

    fileInputEl.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      await addFile(f);
      fileInputEl.value = '';
    });

    sendBtnEl.addEventListener('click', send);

    textInputEl.addEventListener('input', autosizeTextarea);

    textInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    // Paste images
    document.addEventListener('paste', async (e) => {
      const items = Array.from(e.clipboardData?.items || []);
      const imgItem = items.find(it => it.type && it.type.startsWith('image/'));
      if (!imgItem) return;
      e.preventDefault();
      await addFile(imgItem.getAsFile());
    });

    // Drag/drop
    let dragCounter = 0;

    document.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragCounter++;
      dropOverlayEl.classList.add('active');
    });

    document.addEventListener('dragover', (e) => e.preventDefault());

    document.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dragCounter = Math.max(0, dragCounter - 1);
      if (dragCounter === 0) dropOverlayEl.classList.remove('active');
    });

    document.addEventListener('drop', async (e) => {
      e.preventDefault();
      dragCounter = 0;
      dropOverlayEl.classList.remove('active');
      const f = e.dataTransfer?.files?.[0];
      await addFile(f);
    });

    // Modal close
    closeModalBtnEl.addEventListener('click', closeModal);
    imgModalEl.addEventListener('click', (e) => {
      if (e.target === imgModalEl) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    textInputEl.focus();
  </script>
</body>
</html>
